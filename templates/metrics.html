<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .content {
            padding: 30px;
        }
        .filters {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e3e6ff;
        }
        .filters h3 {
            margin: 0 0 20px 0;
            color: #4c51bf;
            font-size: 1.3em;
        }
        .filter-row {
            display: flex;
            gap: 20px;
            align-items: end;
            flex-wrap: wrap;
        }
        .make_row {
            flex-direction: row !important;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .filter-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .filter-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .filter-btn:hover {
            transform: translateY(-2px);
        }
        .clear-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .stat-label {
            opacity: 0.9;
            font-size: 1em;
        }
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .event-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .event-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            word-break: break-all;
        }
        .event-count {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .event-label {
            color: #6b7280;
            font-size: 0.9em;
        }
        .sources-section {
            margin-top: 40px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .source-card {
            background: #f8f9ff;
            border: 2px solid #e3e6ff;
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .source-name {
            font-weight: 600;
            color: #4c51bf;
        }
        .source-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .raw-data {
            margin-top: 40px;
            background: #f9fafb;
            border-radius: 12px;
            overflow: hidden;
        }
        .raw-data h3 {
            background: #374151;
            color: white;
            margin: 0;
            padding: 20px;
            font-size: 1.2em;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        .data-table tr:hover {
            background-color: #f8f9ff;
        }
        .uid {
            font-family: 'Courier New', monospace;
            background-color: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .source {
            color: #6b7280;
            font-weight: 500;
        }
        .timestamp {
            color: #9ca3af;
            font-size: 0.9em;
        }
        .empty {
            text-align: center;
            color: #6b7280;
            padding: 60px;
            font-style: italic;
            font-size: 1.1em;
        }
        
        /* –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ */
        .funnel-section {
            margin: 40px 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .funnel-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .funnel-step {
            position: relative;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .funnel-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .funnel-step-content {
            position: relative;
            padding: 20px;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .funnel-step-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            opacity: 0.1;
            transition: width 0.8s ease-in-out;
            border-radius: 12px;
        }
        
        .funnel-step-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .funnel-step-icon {
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .funnel-step-info {
            display: flex;
            flex-direction: column;
        }
        
        .funnel-step-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .funnel-step-description {
            font-size: 0.9em;
            color: #6b7280;
        }
        
        .funnel-step-metrics {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }
        
        .funnel-step-count {
            font-size: 2em;
            font-weight: bold;
            color: #1f2937;
            line-height: 1;
        }
        
        .funnel-step-conversion {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .funnel-step-conversion.good {
            color: #059669;
            font-weight: 600;
        }
        
        .funnel-step-conversion.average {
            color: #d97706;
            font-weight: 600;
        }
        
        .funnel-step-conversion.poor {
            color: #dc2626;
            font-weight: 600;
        }
        
        .funnel-arrow {
            text-align: center;
            margin: 10px 0;
            font-size: 1.5em;
            color: #9ca3af;
        }
        
        .conversion-insights {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        
        .conversion-insights h4 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 1.2em;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .insight-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .insight-card.excellent {
            background: #ecfdf5;
            color: #065f46;
            border: 2px solid #a7f3d0;
        }
        
        .insight-card.good {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fde68a;
        }
        
        .insight-card.needs-improvement {
            background: #fef2f2;
            color: #991b1b;
            border: 2px solid #fecaca;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            .events-grid {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            .funnel-step-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .funnel-step-left {
                flex-direction: column;
            }
            .funnel-step-metrics {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π</h1>
            <p>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è: reton_web, telegram, whatsapp</p>
            <div style="position: absolute; top: 20px; right: 20px;">
                <a href="/logout" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.9em;">
                    üö™ –í—ã—Ö–æ–¥
                </a>
            </div>
        </div>
        
        <div class="content">
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters">
                <h3>üîç –§–∏–ª—å—Ç—Ä—ã</h3>
                <form method="get" class="filter-row">
                    <div class="filter-group">
                        <label for="source_filter">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                        <select name="source_filter" id="source_filter">
                            <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                            {% for source in all_sources %}
                            <option value="{{ source }}" {% if source == current_source %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="date_from">–û—Ç –¥–∞—Ç—ã:</label>
                        <input type="date" name="date_from" id="date_from" value="{{ date_from or '' }}">
                    </div>
                    
                    <div class="filter-group">
                        <label for="date_to">–î–æ –¥–∞—Ç—ã:</label>
                        <input type="date" name="date_to" id="date_to" value="{{ date_to or '' }}">
                    </div>
                    
                    <div class="filter-group make_row">
                        <button type="submit" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <a href="/" class="clear-btn">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    </div>
                </form>
            </div>

            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats">
                <div class="stat">
                    <span class="stat-number">{{ total_metrics }}</span>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</div>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ unique_events }}</span>
                    <div class="stat-label">–¢–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π</div>
                </div>
                <div class="stat">
                    <span class="stat-number">{{ unique_sources }}</span>
                    <div class="stat-label">–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–±—ã—Ç–∏–π -->
            {% if event_stats %}
            <div class="section-title">üéØ –°–æ–±—ã—Ç–∏—è –ø–æ —Ç–∏–ø–∞–º</div>
            <div class="events-grid">
                {% for event in event_stats %}
                <div class="event-card">
                    <div class="event-name">{{ event.uid }}</div>
                    <div class="event-count">{{ event.count }}</div>
                    <div class="event-label">—Å–æ–±—ã—Ç–∏–π</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ -->
            {% if funnel_data %}
            <div class="funnel-section">
                <div class="section-title">üìà –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</div>
                <div class="funnel-container">
                    {% for step in funnel_data %}
                    {% if step.count > 0 %}
                    <div class="funnel-step">
                        <div class="funnel-step-progress" style="background-color: {{ step.color }}; width: {{ step.width }}%;"></div>
                        <div class="funnel-step-content">
                            <div class="funnel-step-left">
                                <div class="funnel-step-icon">{{ step.icon }}</div>
                                <div class="funnel-step-info">
                                    <div class="funnel-step-name">{{ step.name }}</div>
                                    <div class="funnel-step-description">–≠—Ç–∞–ø {{ loop.index }} –≤–æ—Ä–æ–Ω–∫–∏</div>
                                </div>
                            </div>
                            <div class="funnel-step-metrics">
                                <div class="funnel-step-count">{{ step.count }}</div>
                                <div class="funnel-step-conversion
                                    {% if loop.index == 1 %}
                                        good
                                    {% elif step.conversion >= 70 %}
                                        good
                                    {% elif step.conversion >= 40 %}
                                        average
                                    {% else %}
                                        poor
                                    {% endif %}
                                ">
                                    {% if loop.index == 1 %}
                                        –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞
                                    {% else %}
                                        {{ "%.1f"|format(step.conversion) }}% –∫–æ–Ω–≤–µ—Ä—Å–∏—è
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if not loop.last %}
                    <div class="funnel-arrow">‚¨á</div>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                    
                    <!-- –ò–Ω—Å–∞–π—Ç—ã –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ -->
                    <div class="conversion-insights">
                        <h4>üí° –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</h4>
                        <div class="insights-grid">
                            {% set total_conversion = (funnel_data[-1].count / funnel_data[0].count * 100) if funnel_data[0].count > 0 else 0 %}
                            
                            <div class="insight-card
                                {% if total_conversion >= 15 %}
                                    excellent
                                {% elif total_conversion >= 8 %}
                                    good
                                {% else %}
                                    needs-improvement
                                {% endif %}
                            ">
                                <strong>{{ "%.1f"|format(total_conversion) }}%</strong><br>
                                –û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è
                            </div>
                            
                            {% set max_dropoff = 0 %}
                            {% set max_dropoff_step = '' %}
                            {% for step in funnel_data[1:] %}
                                {% if (100 - step.conversion) > max_dropoff %}
                                    {% set max_dropoff = 100 - step.conversion %}
                                    {% set max_dropoff_step = step.name %}
                                {% endif %}
                            {% endfor %}
                            
                            <div class="insight-card needs-improvement">
                                <strong>{{ max_dropoff_step }}</strong><br>
                                –ù–∞–∏–±–æ–ª—å—à–∏–π –æ—Ç—Ç–æ–∫
                            </div>
                            
                            {% set active_steps = funnel_data | selectattr("count", "gt", 0) | list | length %}
                            <div class="insight-card good">
                                <strong>{{ active_steps }}/{{ funnel_data | length }}</strong><br>
                                –ê–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º -->
            {% if source_stats %}
            <div class="sources-section">
                <div class="section-title">üìç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</div>
                <div class="sources-grid">
                    {% for source in source_stats %}
                    <div class="source-card">
                        <div class="source-name">{{ source.source }}</div>
                        <div class="source-count">{{ source.count }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            {% if metrics %}
            <div class="raw-data">
                <h3>üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–°–æ–±—ã—Ç–∏–µ</th>
                            <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                            <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for metric in metrics[:100] %}
                        <tr>
                            <td><strong>{{ metric.id }}</strong></td>
                            <td><span class="uid">{{ metric.uid }}</span></td>
                            <td><span class="source">{{ metric.source }}</span></td>
                            <td><span class="timestamp">{{ metric.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span></td>
                        </tr>
                        {% endfor %}
                        {% if metrics|length > 100 %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #6b7280; font-style: italic;">
                                ... –∏ –µ—â—ë {{ metrics|length - 100 }} –∑–∞–ø–∏—Å–µ–π
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty">
                üì≠ –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –≤ –ø–æ–ª–µ "–¥–æ" –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
        document.addEventListener('DOMContentLoaded', function() {
            const dateFromInput = document.getElementById('date_from');
            const dateToInput = document.getElementById('date_to');
            
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ "–æ—Ç" –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –∞ "–¥–æ" –Ω–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
            if (dateFromInput.value && !dateToInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateToInput.value = today;
            }
        });
    </script>
</body>
</html>